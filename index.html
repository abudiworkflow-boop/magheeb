<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Ø§Ù„Ù…ØºÙŠØ¨ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ â€” ÙˆØ§ØªØ³Ø§Ø¨</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: -apple-system, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: #111b21;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100dvh;
    }

    /* â”€â”€ PHONE FRAME (desktop) â”€â”€ */
    .phone {
      width: 100%;
      max-width: 420px;
      height: 100dvh;
      max-height: 820px;
      display: flex;
      flex-direction: column;
      background: #0b141a;
      position: relative;
      overflow: hidden;
    }

    /* â”€â”€ HEADER â”€â”€ */
    .wa-header {
      background: #202c33;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      border-bottom: 1px solid #2a3942;
    }

    .back-btn {
      color: #00a884;
      font-size: 22px;
      cursor: pointer;
      line-height: 1;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00a884, #007a60);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .contact-info { flex: 1; min-width: 0; }
    .contact-info h2 {
      font-size: 15px;
      font-weight: 600;
      color: #e9edef;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .contact-info p {
      font-size: 12px;
      color: #00a884;
      margin-top: 1px;
    }

    .header-icons { display: flex; gap: 20px; color: #aebac1; font-size: 20px; }

    /* â”€â”€ CHAT BACKGROUND â”€â”€ */
    .chat-bg {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px 8px 8px;
      background-color: #0b141a;
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23182229' fill-opacity='0.6'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      scroll-behavior: smooth;
    }

    .chat-bg::-webkit-scrollbar { width: 5px; }
    .chat-bg::-webkit-scrollbar-track { background: transparent; }
    .chat-bg::-webkit-scrollbar-thumb { background: #2a3942; border-radius: 3px; }

    /* â”€â”€ DATE BADGE â”€â”€ */
    .date-badge {
      text-align: center;
      margin: 8px 0 14px;
    }
    .date-badge span {
      background: #182229;
      color: #8696a0;
      font-size: 11.5px;
      padding: 4px 10px;
      border-radius: 6px;
    }

    /* â”€â”€ MESSAGES â”€â”€ */
    .msg-wrap {
      display: flex;
      margin-bottom: 2px;
    }
    .msg-wrap.bot  { justify-content: flex-start; padding-right: 40px; }
    .msg-wrap.user { justify-content: flex-end;   padding-left: 40px; }
    .msg-wrap.bot + .msg-wrap.user,
    .msg-wrap.user + .msg-wrap.bot { margin-top: 8px; }

    .bubble {
      max-width: 85%;
      padding: 7px 10px 6px 12px;
      border-radius: 8px;
      font-size: 14.2px;
      line-height: 1.55;
      position: relative;
      word-break: break-word;
      white-space: pre-wrap;
    }

    /* Bot bubble (incoming) */
    .msg-wrap.bot .bubble {
      background: #202c33;
      color: #e9edef;
      border-top-right-radius: 0;
    }
    .msg-wrap.bot .bubble::before {
      content: '';
      position: absolute;
      top: 0;
      right: -8px;
      border: 8px solid transparent;
      border-top-color: #202c33;
      border-right: none;
    }

    /* User bubble (outgoing) */
    .msg-wrap.user .bubble {
      background: #005c4b;
      color: #e9edef;
      border-top-left-radius: 0;
    }
    .msg-wrap.user .bubble::before {
      content: '';
      position: absolute;
      top: 0;
      left: -8px;
      border: 8px solid transparent;
      border-top-color: #005c4b;
      border-left: none;
    }

    .bubble-time {
      font-size: 10.5px;
      color: #8696a0;
      float: left;
      margin-top: 3px;
      margin-right: -2px;
      margin-left: 6px;
      line-height: 1;
    }
    .msg-wrap.user .bubble-time::after {
      content: ' âœ“âœ“';
      color: #53bdeb;
    }

    /* â”€â”€ TYPING INDICATOR â”€â”€ */
    .typing-wrap {
      display: flex;
      justify-content: flex-start;
      padding-right: 40px;
      margin-bottom: 8px;
    }
    .typing-bubble {
      background: #202c33;
      border-radius: 8px;
      border-top-right-radius: 0;
      padding: 12px 14px 10px;
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .typing-bubble::before {
      content: '';
      position: absolute;
      top: 0;
      right: -8px;
      border: 8px solid transparent;
      border-top-color: #202c33;
      border-right: none;
    }
    .td {
      width: 8px; height: 8px;
      background: #8696a0;
      border-radius: 50%;
      animation: tdBounce 1.3s infinite ease-in-out;
    }
    .td:nth-child(1) { animation-delay: 0s; }
    .td:nth-child(2) { animation-delay: 0.2s; }
    .td:nth-child(3) { animation-delay: 0.4s; }
    @keyframes tdBounce {
      0%,60%,100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-5px); opacity: 1; }
    }

    /* â”€â”€ INPUT BAR â”€â”€ */
    .input-bar {
      background: #202c33;
      padding: 8px 10px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      flex-shrink: 0;
    }

    .input-box {
      flex: 1;
      background: #2a3942;
      border: none;
      border-radius: 22px;
      padding: 10px 16px;
      color: #e9edef;
      font-size: 14.5px;
      font-family: inherit;
      resize: none;
      outline: none;
      min-height: 44px;
      max-height: 120px;
      line-height: 1.5;
      direction: auto;
    }
    .input-box::placeholder { color: #8696a0; }

    .send-btn {
      width: 44px; height: 44px;
      border-radius: 50%;
      background: #00a884;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.15s, transform 0.1s;
    }
    .send-btn:hover  { background: #00cf9d; }
    .send-btn:active { transform: scale(0.93); }
    .send-btn:disabled { background: #2a3942; cursor: default; transform: none; }
    .send-btn svg { width: 22px; height: 22px; fill: #fff; }

    .emoji-btn {
      width: 40px; height: 44px;
      background: none;
      border: none;
      color: #8696a0;
      font-size: 22px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }

    /* â”€â”€ QUICK REPLIES â”€â”€ */
    .quick-wrap {
      padding: 6px 8px 2px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-start;
    }
    .qr {
      background: #202c33;
      border: 1px solid #2a3942;
      color: #00a884;
      border-radius: 18px;
      padding: 5px 13px;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.15s;
      white-space: nowrap;
    }
    .qr:hover { background: #2a3942; }

    @media (max-width: 440px) {
      .phone { max-height: 100dvh; border-radius: 0; }
    }
  </style>
</head>
<body>

<div class="phone">

  <!-- Header -->
  <div class="wa-header">
    <div class="back-btn">â€¹</div>
    <div class="avatar">ğŸ¢</div>
    <div class="contact-info">
      <h2>Ø§Ù„Ù…ØºÙŠØ¨ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ</h2>
      <p id="status-text">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† â€¢ online</p>
    </div>
    <div class="header-icons">
      <span title="Ø§ØªØµØ§Ù„">ğŸ“</span>
      <span title="Ø§Ù„Ù…Ø²ÙŠØ¯">â‹®</span>
    </div>
  </div>

  <!-- Chat area -->
  <div class="chat-bg" id="chat">

    <div class="date-badge"><span>Ø§Ù„ÙŠÙˆÙ… â€¢ Today</span></div>

    <!-- Welcome message -->
    <div class="msg-wrap bot" id="welcome-msg">
      <div class="bubble">
        Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹! ğŸ‘‹ Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…ØºÙŠØ¨ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ.<br><br>
        ÙŠØ³Ø¹Ø¯Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø£ÙŠ Ø´ÙŠØ¡ ÙŠØ®Øµ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª â€” Ø³ÙˆØ§Ø¡ ÙƒÙ†Øª ØªØ¨Ø­Ø« Ø¹Ù† Ø´Ø±Ø§Ø¡ØŒ Ø¥ÙŠØ¬Ø§Ø±ØŒ Ø§Ø³ØªØ«Ù…Ø§Ø±ØŒ Ø£Ùˆ Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø³Ø¤Ø§Ù„.<br><br>
        ÙƒÙŠÙ Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ
        <span class="bubble-time" id="welcome-time"></span>
      </div>
    </div>

    <!-- Quick replies -->
    <div class="quick-wrap" id="qr-wrap">
      <button class="qr" onclick="sendQuick('Ø£Ø±ÙŠØ¯ Ø´Ø±Ø§Ø¡ Ø´Ù‚Ø© ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶')">ğŸ  Ø´Ø±Ø§Ø¡ Ø´Ù‚Ø©</button>
      <button class="qr" onclick="sendQuick('Ù…Ø§ Ù‡ÙŠ Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ØºÙŠØ¨ØŸ')">ğŸ—ï¸ Ù…Ø´Ø§Ø±ÙŠØ¹ÙƒÙ…</button>
      <button class="qr" onclick="sendQuick('ÙƒÙ… Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙÙŠ Ø­ÙŠ Ø§Ù„ØµØ­Ø§ÙØ©ØŸ')">ğŸ’° Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</button>
      <button class="qr" onclick="sendQuick('I want to invest in real estate')">ğŸ‡¬ğŸ‡§ English</button>
    </div>

  </div>

  <!-- Input bar -->
  <div class="input-bar">
    <button class="emoji-btn">ğŸ˜Š</button>
    <textarea
      class="input-box"
      id="input"
      placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."
      rows="1"
      onkeydown="handleKey(event)"
      oninput="grow(this)"
    ></textarea>
    <button class="send-btn" id="send-btn" onclick="send()">
      <svg viewBox="0 0 24 24"><path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"/></svg>
    </button>
  </div>

</div>

<script>
  const WEBHOOK = 'https://abudii.app.n8n.cloud/webhook/real-estate-leads';

  // Session ID
  let sid = sessionStorage.getItem('wa_sid');
  if (!sid) {
    sid = 'wa_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
    sessionStorage.setItem('wa_sid', sid);
  }

  // Set welcome time
  document.getElementById('welcome-time').textContent = clock();

  function clock() {
    return new Date().toLocaleTimeString('ar', {hour:'2-digit', minute:'2-digit'});
  }

  function grow(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
  }

  function scrollDown() {
    const c = document.getElementById('chat');
    setTimeout(() => c.scrollTop = c.scrollHeight, 50);
  }

  function addMsg(role, text) {
    // Remove quick replies on first user message
    if (role === 'user') {
      const qr = document.getElementById('qr-wrap');
      if (qr) qr.remove();
    }

    const chat = document.getElementById('chat');
    const wrap = document.createElement('div');
    wrap.className = 'msg-wrap ' + role;

    const bbl = document.createElement('div');
    bbl.className = 'bubble';
    bbl.innerHTML = nl2br(esc(text)) +
      `<span class="bubble-time">${clock()}</span>`;

    wrap.appendChild(bbl);
    chat.appendChild(wrap);
    scrollDown();
  }

  function showTyping() {
    const chat = document.getElementById('chat');
    const wrap = document.createElement('div');
    wrap.className = 'typing-wrap';
    wrap.id = 'typing';
    wrap.style.position = 'relative';
    wrap.innerHTML = `<div class="typing-bubble"><div class="td"></div><div class="td"></div><div class="td"></div></div>`;
    chat.appendChild(wrap);
    scrollDown();
  }

  function hideTyping() {
    const t = document.getElementById('typing');
    if (t) t.remove();
  }

  function esc(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function nl2br(s) { return s.replace(/\n/g,'<br>'); }

  let busy = false;

  async function send() {
    const inp = document.getElementById('input');
    const btn = document.getElementById('send-btn');
    const text = inp.value.trim();
    if (!text || busy) return;

    busy = true;
    btn.disabled = true;
    inp.value = '';
    inp.style.height = 'auto';

    addMsg('user', text);
    showTyping();

    // Show "typing..." in status
    document.getElementById('status-text').textContent = 'ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†... â€¢ typing';

    try {
      const res = await fetch(WEBHOOK, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text, session_id: sid })
      });

      hideTyping();

      if (!res.ok) {
        const err = await res.text().catch(() => '');
        addMsg('bot', 'âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… (' + res.status + '). Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.\n\n' + err.slice(0,150));
      } else {
        const reply = await res.text();
        addMsg('bot', reply && reply.trim() ? reply.trim() : 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ÙÙ‡Ù… Ø·Ù„Ø¨Ùƒ. Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØµÙŠØ§ØºØ©ØŸ');
      }

    } catch(e) {
      hideTyping();
      addMsg('bot',
        'âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….\n\nØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ workflow ÙÙŠ n8n ÙˆØ¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª OpenAI.\n\n' + e.message
      );
    } finally {
      document.getElementById('status-text').textContent = 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† â€¢ online';
      busy = false;
      btn.disabled = false;
      inp.focus();
    }
  }

  function sendQuick(t) {
    document.getElementById('input').value = t;
    send();
  }
</script>

</body>
</html>
