<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ù„Ù…ØºÙŠØ¨ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ â€” Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', 'Arial', sans-serif;
      background: #0f1117;
      color: #e8e8e8;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* â”€â”€ CHAT WRAPPER â”€â”€ */
    .chat-wrapper {
      width: 100%;
      max-width: 500px;
      height: 100dvh;
      max-height: 820px;
      display: flex;
      flex-direction: column;
      background: #16181f;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 30px 80px rgba(0,0,0,0.5);
    }

    /* â”€â”€ HEADER â”€â”€ */
    .header {
      background: linear-gradient(135deg, #1a3a2a 0%, #0d2318 100%);
      padding: 18px 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      border-bottom: 1px solid #2a4035;
    }

    .logo-circle {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
      box-shadow: 0 0 16px rgba(46,204,113,0.4);
    }

    .header-info { flex: 1; }
    .header-info h1 { font-size: 15px; font-weight: 700; color: #fff; letter-spacing: 0.3px; }
    .header-info p  { font-size: 11.5px; color: #7ec99a; margin-top: 2px; }

    .status-dot {
      width: 9px; height: 9px;
      background: #2ecc71;
      border-radius: 50%;
      box-shadow: 0 0 8px #2ecc71;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%,100% { opacity: 1; }
      50%      { opacity: 0.4; }
    }

    /* â”€â”€ MESSAGES â”€â”€ */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }

    .messages::-webkit-scrollbar { width: 4px; }
    .messages::-webkit-scrollbar-track { background: transparent; }
    .messages::-webkit-scrollbar-thumb { background: #2a3040; border-radius: 4px; }

    /* â”€â”€ BUBBLE â”€â”€ */
    .bubble-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .bubble-row.bot  { justify-content: flex-start; }
    .bubble-row.user { justify-content: flex-end; flex-direction: row-reverse; }

    .avatar {
      width: 30px; height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2ecc71, #1a8a4a);
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .bubble {
      max-width: 78%;
      padding: 11px 15px;
      border-radius: 18px;
      font-size: 13.5px;
      line-height: 1.65;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .bubble-row.bot  .bubble {
      background: #1e2330;
      color: #d8e0ec;
      border-bottom-right-radius: 4px;
      border: 1px solid #2a3040;
    }

    .bubble-row.user .bubble {
      background: linear-gradient(135deg, #1e5c35, #2ecc71);
      color: #fff;
      border-bottom-left-radius: 4px;
    }

    .bubble time {
      display: block;
      font-size: 10px;
      opacity: 0.5;
      margin-top: 5px;
      text-align: left;
    }

    /* â”€â”€ TYPING INDICATOR â”€â”€ */
    .typing-row { display: flex; align-items: flex-end; gap: 8px; }

    .typing-bubble {
      background: #1e2330;
      border: 1px solid #2a3040;
      border-radius: 18px;
      border-bottom-right-radius: 4px;
      padding: 12px 16px;
      display: flex; gap: 5px; align-items: center;
    }

    .dot {
      width: 7px; height: 7px;
      background: #5a7a6a;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .dot:nth-child(1) { animation-delay: 0s; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%,80%,100% { transform: translateY(0); opacity: 0.4; }
      40%          { transform: translateY(-6px); opacity: 1; }
    }

    /* â”€â”€ INPUT AREA â”€â”€ */
    .input-area {
      padding: 14px 14px 18px;
      background: #16181f;
      border-top: 1px solid #1e2330;
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    textarea {
      flex: 1;
      background: #1e2330;
      border: 1px solid #2a3545;
      border-radius: 14px;
      color: #e0e8f0;
      font-size: 13.5px;
      padding: 11px 14px;
      resize: none;
      outline: none;
      min-height: 44px;
      max-height: 130px;
      line-height: 1.5;
      font-family: inherit;
      transition: border-color 0.2s;
      direction: auto;
    }

    textarea:focus { border-color: #2ecc71; }
    textarea::placeholder { color: #4a5568; }

    .send-btn {
      width: 44px; height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2ecc71, #1a8a4a);
      border: none;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      transition: transform 0.15s, box-shadow 0.15s;
      box-shadow: 0 4px 14px rgba(46,204,113,0.35);
    }

    .send-btn:hover  { transform: scale(1.08); box-shadow: 0 6px 18px rgba(46,204,113,0.5); }
    .send-btn:active { transform: scale(0.95); }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .send-btn svg { width: 20px; height: 20px; fill: #fff; }

    /* â”€â”€ SESSION BADGE â”€â”€ */
    .session-badge {
      text-align: center;
      font-size: 10.5px;
      color: #3a4a5a;
      padding: 6px 0 2px;
      letter-spacing: 0.5px;
    }

    /* â”€â”€ WELCOME CARD â”€â”€ */
    .welcome {
      background: linear-gradient(135deg, #1a3a2a, #0f2018);
      border: 1px solid #2a4035;
      border-radius: 14px;
      padding: 18px;
      margin: 8px 0 4px;
      text-align: center;
    }

    .welcome h2 { font-size: 16px; color: #2ecc71; margin-bottom: 6px; }
    .welcome p  { font-size: 12.5px; color: #8aab9a; line-height: 1.7; }

    /* â”€â”€ QUICK REPLIES â”€â”€ */
    .quick-replies {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
      padding: 4px 0;
      justify-content: flex-start;
    }

    .qr-btn {
      background: #1e2b38;
      border: 1px solid #2a4050;
      color: #7ec9aa;
      border-radius: 20px;
      padding: 6px 13px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
      font-family: inherit;
    }

    .qr-btn:hover { background: #1e3a2a; border-color: #2ecc71; color: #2ecc71; }

    /* â”€â”€ LEAD SAVED BADGE â”€â”€ */
    .lead-saved {
      text-align: center;
      padding: 8px 14px;
      background: linear-gradient(90deg, #0d2318, #1a3a2a, #0d2318);
      border: 1px solid #2a4035;
      border-radius: 10px;
      font-size: 11.5px;
      color: #2ecc71;
    }

    /* mobile */
    @media (max-width: 520px) {
      .chat-wrapper { border-radius: 0; max-height: 100dvh; }
    }
  </style>
</head>
<body>

<div class="chat-wrapper">

  <!-- Header -->
  <div class="header">
    <div class="logo-circle">ğŸ¢</div>
    <div class="header-info">
      <h1>Ø§Ù„Ù…ØºÙŠØ¨ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ</h1>
      <p>Al-Mughib Real Estate â€” AI Assistant</p>
    </div>
    <div class="status-dot"></div>
  </div>

  <!-- Messages -->
  <div class="messages" id="messages">

    <!-- Welcome card -->
    <div class="welcome">
      <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h2>
      <p>Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Ø§Ù„Ù…ØºÙŠØ¨ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ.<br>Ø³Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø¥ÙŠØ¬Ø§Ø¯ Ø¹Ù‚Ø§Ø±Ùƒ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ.</p>
    </div>

    <!-- Greeting message from bot -->
    <div class="bubble-row bot" id="greeting-row">
      <div class="avatar">ğŸ¤–</div>
      <div class="bubble">
        Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…ØºÙŠØ¨ Ù„Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ ğŸ <br><br>
        ÙŠØ³Ø¹Ø¯Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ùƒ. Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ù…Ø¹Ø±ÙØ© Ø§Ø³Ù…ÙƒØŸ
        <time id="greeting-time"></time>
      </div>
    </div>

    <!-- Quick replies -->
    <div class="bubble-row bot">
      <div style="width:30px;flex-shrink:0;"></div>
      <div class="quick-replies" id="quick-replies">
        <button class="qr-btn" onclick="sendQuick('Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ÙŠØ¯ Ø´Ø±Ø§Ø¡ Ø´Ù‚Ø©')">ğŸ  Ø´Ø±Ø§Ø¡ Ø´Ù‚Ø©</button>
        <button class="qr-btn" onclick="sendQuick('Ø£Ø¨Ø­Ø« Ø¹Ù† ÙÙŠÙ„Ø§ Ù„Ù„Ø¨ÙŠØ¹')">ğŸ¡ ÙÙŠÙ„Ø§</button>
        <button class="qr-btn" onclick="sendQuick('Ø£Ø±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙÙŠ Ø¹Ù‚Ø§Ø±')">ğŸ“ˆ Ø§Ø³ØªØ«Ù…Ø§Ø±</button>
        <button class="qr-btn" onclick="sendQuick('Hello, I need help finding a property')">ğŸ‡¬ğŸ‡§ English</button>
      </div>
    </div>

  </div>

  <!-- Session badge -->
  <div class="session-badge" id="session-badge">Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>

  <!-- Input -->
  <div class="input-area">
    <textarea
      id="input"
      placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§... / Type your message..."
      rows="1"
      onkeydown="handleKey(event)"
      oninput="autoResize(this)"
    ></textarea>
    <button class="send-btn" id="send-btn" onclick="sendMessage()" title="Ø¥Ø±Ø³Ø§Ù„">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
      </svg>
    </button>
  </div>

</div>

<script>
  // â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const WEBHOOK_URL = 'https://abudii.app.n8n.cloud/webhook/real-estate-leads';

  // â”€â”€ SESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let sessionId = localStorage.getItem('re_session_id');
  if (!sessionId) {
    sessionId = 'demo_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8);
    localStorage.setItem('re_session_id', sessionId);
  }

  const badge = document.getElementById('session-badge');
  badge.textContent = 'Session: ' + sessionId.slice(0, 24) + 'â€¦';

  // Set greeting time
  document.getElementById('greeting-time').textContent = now();

  // â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function now() {
    return new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
  }

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 130) + 'px';
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }

  function scrollBottom() {
    const m = document.getElementById('messages');
    m.scrollTop = m.scrollHeight;
  }

  // â”€â”€ RENDER MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function appendMessage(role, text) {
    const msgs = document.getElementById('messages');

    // Remove quick replies after first user message
    if (role === 'user') {
      const qr = document.getElementById('quick-replies');
      if (qr) qr.remove();
    }

    const row = document.createElement('div');
    row.className = 'bubble-row ' + role;

    if (role === 'bot') {
      row.innerHTML = `
        <div class="avatar">ğŸ¤–</div>
        <div class="bubble">${escapeHtml(text)}<time>${now()}</time></div>
      `;
    } else {
      row.innerHTML = `
        <div class="bubble">${escapeHtml(text)}<time>${now()}</time></div>
        <div class="avatar" style="background:linear-gradient(135deg,#2a5080,#1a3a60)">ğŸ‘¤</div>
      `;
    }

    msgs.appendChild(row);
    scrollBottom();
    return row;
  }

  function showTyping() {
    const msgs = document.getElementById('messages');
    const row = document.createElement('div');
    row.className = 'typing-row';
    row.id = 'typing';
    row.innerHTML = `
      <div class="avatar">ğŸ¤–</div>
      <div class="typing-bubble">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    `;
    msgs.appendChild(row);
    scrollBottom();
  }

  function hideTyping() {
    const t = document.getElementById('typing');
    if (t) t.remove();
  }

  function showLeadSaved() {
    const msgs = document.getElementById('messages');
    const el = document.createElement('div');
    el.className = 'lead-saved';
    el.innerHTML = 'âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ â€” Lead Saved to Google Sheets';
    msgs.appendChild(el);
    scrollBottom();
  }

  function escapeHtml(text) {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/\n/g, '<br>');
  }

  // â”€â”€ SEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let busy = false;

  async function sendMessage() {
    const input = document.getElementById('input');
    const btn   = document.getElementById('send-btn');
    const text  = input.value.trim();
    if (!text || busy) return;

    busy = true;
    btn.disabled = true;
    input.value = '';
    input.style.height = 'auto';

    appendMessage('user', text);
    showTyping();

    try {
      const res = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: text,
          session_id: sessionId
        })
      });

      hideTyping();

      if (!res.ok) {
        const errText = await res.text();
        appendMessage('bot', `âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ (${res.status}). ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ workflow ÙÙŠ n8n.\n\nError: ${errText.slice(0, 200)}`);
      } else {
        const reply = await res.text();
        appendMessage('bot', reply || '...');

        // Detect if lead was saved
        if (reply.includes('ØªÙ… ØªØ³Ø¬ÙŠÙ„') || reply.includes('saved') || reply.includes('Ø³ÙŠØªÙˆØ§ØµÙ„')) {
          showLeadSaved();
        }
      }

    } catch (err) {
      hideTyping();
      appendMessage('bot',
        'âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….\n\nØªØ£ÙƒØ¯ Ù…Ù†:\nâ€¢ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ workflow ÙÙŠ n8n\nâ€¢ Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª OpenAI Ùˆ Google Sheets\n\n' + err.message
      );
    } finally {
      busy = false;
      btn.disabled = false;
      input.focus();
    }
  }

  function sendQuick(text) {
    document.getElementById('input').value = text;
    sendMessage();
  }

  // Focus input on load
  document.getElementById('input').focus();
</script>

</body>
</html>
